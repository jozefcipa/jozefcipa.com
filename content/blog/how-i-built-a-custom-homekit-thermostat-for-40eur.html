---
title: How I built a custom Homekit thermostat for 40‚Ç¨
tags:
  - C
  - homekit
  - iot
  - esp32
  - LVGL
date: '2025-03-09T18:22:16.399Z'
slug: how-i-built-a-custom-homekit-thermostat-for-40eur
draft: false
---

<article id="12677955-515e-8037-be53-e7832bb10412" class="page sans"><div class="page-body"><figure id="1af77955-515e-80c8-98f1-f97bf2b14231"><div class="source">
  <video src="https://assets.jozefcipa.com/blog/12677955515e8037be53e7832bb10412/thermostat.mp4" controls autoplay muted></video>
</div></figure><p id="1af77955-515e-80b2-ac43-dab2e2baba4e" class="">I wanted a smart HomeKit thermostat for a long time. The only problem is that it is quite expensive so I never bought one. Last year, <a href="https://www.espressif.com/">Espressif</a> organized an introductory workshop to familiarize people with ESP32. I‚Äôve heard about this board before but didn‚Äôt know what exactly it was and never really played with it. So I signed up for the workshop to get hands-on experience with the chip. If you don‚Äôt know what ESP32 is, you can think of it as something between Arduino and Raspberry Pi - a microprocessor that you can program in C with GPIO pins, WiFi and Bluetooth connectivity.</p><p id="1af77955-515e-806c-b290-f95e8ca881bb" class="">Some time after the workshop, I got an idea to try to make my own thermostat using the ESP32 chip I got from the event. I saw this as a great opportunity to deepen my knowledge about this board and at the same time build something useful.</p><h2 id="1a777955-515e-80a7-bcd3-db60ba69b8d6" class="">The idea</h2><p id="1af77955-515e-8099-b781-c7e7b9e25c2a" class="">The main thing was to define a goal - what exactly do I want my thermostat to be capable of and how should it work. Obviously, it has to be <strong>HomeKit compatible</strong>, so I can control it with my iPhone. Also, once I mount it on the wall, it would be nice to have<strong> instant visual feedback </strong>to see the current room temperature and heating state. Also, anyone should be able to <strong>control the temperature directly</strong> via the thermostat. That means the thermostat needs to have an <strong>LCD screen. </strong>Moreover, since I want to be able to interact with it to change the temperature, it has to provide some user interface. I decided to use a <strong>touch screen</strong> as I wanted to avoid adding a bunch of physical buttons. And it also feels more natural nowadays. Besides, why not bring on another challenge for myself üòÖ. Obviously, I can‚Äôt forget a <strong>temperature sensor</strong> and a <strong><a href="https://en.wikipedia.org/wiki/Relay">relay</a></strong> to control a boiler.</p><h2 id="1a777955-515e-80fa-85a1-d61af5e18e7f" class="">HomeKit</h2><p id="1af77955-515e-80c9-80d3-f0d15c1ae4c8" class="">HomeKit is the heart of the whole thermostat, without it the project wouldn‚Äôt be possible. That means I had to find a library that would implement the protocol.</p><p id="1af77955-515e-80c4-8d3b-f2a3e5f313d6" class="">There is one library called <a href="https://github.com/HomeSpan/HomeSpan/">Homespan</a>, but this is intended for programming ESP32 in the Arduino environment. This is much easier and beginner friendly, but I wanted something more advanced and challenging :). As I said in the beginning, I wanted to get more familiar with the ESP32 environment and the <a href="https://github.com/espressif/arduino-esp32">arduino-esp32</a> project offers a lot of abstractions. That‚Äôs why I opted for the <a href="https://idf.espressif.com/">ESP-IDF framework</a> instead.</p><p id="1af77955-515e-800b-8604-c8509d083e89" class="">Luckily, there is a great <a href="https://github.com/AchimPieters/esp32-homekit">HomeKit library</a> built by <a href="https://www.studiopieters.nl/">Achim Pieters</a>. It comes with a ton of examples, probably for every possible HomeKit appliance, so implementing not only a thermostat but also anything else becomes much easier.</p><p id="1af77955-515e-8033-9a45-e2bc5e3a667d" class="">After installing and setting up the library, it will start a HomeKit server on the ESP32 and wait for connections from your iOS Home app. Then you will need to generate a QR code as you might know from other smart devices and scan it to add it to your Home app. The QR code generator is a part of the library, so it is very simple to make one.</p><p id="1af77955-515e-8077-aae4-f911d0b0e547" class="">Unfortunately, since this is a custom, <a href="https://mfi.apple.com/">MFi uncertified</a> product, Apple doesn't support configuring WiFi network in the same step as adding the device to the Home app. Therefore, you will need to scan two QR codes, first, one to set the WiFi network, and then another one for registering the device with the Home app. We‚Äôll talk more about the WiFi QR code later.</p><h2 id="1a777955-515e-8024-99b2-dc3c5cc0c86a" class="">Measuring temperature</h2><p id="1af77955-515e-804f-bcec-cc530cba8a9e" class="">Measuring temperature is an important part of every thermostat. In this project, I chose the <a href="https://www.laskakit.cz/en/laskakit-sht40-senzor-teploty-a-vlhkosti-vzduchu/">SHT-40</a> sensor that is cheap but still fairly accurate. Apart from temperature, it can also measure humidity, so this comes in handy too. The sensor communicates with the board via <a href="https://en.wikipedia.org/wiki/I¬≤C">I2C</a> interface. In this project, the temperature is measured in 10 minute intervals.</p><h2 id="1a777955-515e-8084-8f70-df316597355f" class=""><strong>Controlling a boiler</strong></h2><p id="1af77955-515e-801b-b7b2-c54412674d18" class="">If the thermostat evaluates the current room temperature as too low compared to the set target temperature, it will turn on a boiler. To do so, we need a relay that will be switching the boiler on and off. In our case, this will be a <a href="https://www.laskakit.cz/en/1-kanal-5v-rele-modul-s-optickym-oddelenim--high-low-level--250vac-10a/">5V relay</a> with the max load of 250VAC/10A.</p><h2 id="1a777955-515e-80d2-914f-c00fbaefb109" class=""><strong>LCD</strong></h2><p id="1a777955-515e-80ed-8201-d381c555bd7e" class="">I picked the <a href="https://www.laskakit.cz/en/2-4--palcovy-barevny-dotykovy-tft-lcd-displej-240x320-ili9341-spi/">240x320‚Äù TFT display</a> with the touch support. It communicates with the board via  <a href="https://en.wikipedia.org/wiki/Serial_Peripheral_Interface">SPI</a> interface and both display and the touch screen share the same connection. This was quite a challenge to make it work and it took me some time and a lot of head-scratching but eventually I figured it out.</p><h2 id="1a777955-515e-801c-a47a-c7953e6b8989" class=""><strong>Building the UI</strong></h2><p id="1af77955-515e-800f-8f29-fc3e9533da73" class="">The display is connected but the real fun just begins now. I needed to figure out how to create and show GUI elements on the display, and put it all in a nice layout. Not to mention, I had to find a way to connect those UI elements with the touch screen.</p><p id="1af77955-515e-8099-870b-d7188212f0c7" class="">Luckily, there is this awesome graphics library for the embedded devices called <a href="https://lvgl.io/">LVGL</a>. It is very intuitive and easy to use. Moreover, it is inspired by CSS, so it was surprisingly easy to use. But the initial setup and connecting the UI with the LCD screen was quite a challenge.</p><p id="1af77955-515e-806b-920c-e921e3e28e89" class="">Here you can see the diagram of the thermostat GUI. Eventually I ended up creating three different screens for handling various states of the thermostat.</p><figure id="1af77955-515e-8045-a172-d1db47e013fd" class="image"><a href="https://assets.jozefcipa.com/blog/12677955515e8037be53e7832bb10412/gui-flow.png"><img src="https://assets.jozefcipa.com/blog/12677955515e8037be53e7832bb10412/gui-flow.png"></a></figure><h2 id="1a777955-515e-8092-84bd-c20a6610da25" class="">Showing current time</h2><p id="1af77955-515e-8040-b17c-f1c6d1670933" class="">Since we already have the display that shows the room temperature and will be mounted on a wall, I thought it would be cool to also display the current time and date.</p><p id="1af77955-515e-8015-af3c-d48af5ed2475" class="">For that, I used the <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol">NTP</a> protocol that fetches the current time from the internet servers and sets the local clock based on the configured timezone. Then I just created a task that updates the screen with the new time every minute.</p><h2 id="1a777955-515e-80e6-824d-f697f916eea5" class=""><strong>WiFi provisioning</strong></h2><p id="1af77955-515e-80ab-85f6-e6b9071af1c4" class="">I‚Äôm a perfectionist and even though hardcoding the WiFi credentials was the easiest way, I was thinking of the future and the last thing I want to do is having to reprogram the device once the WiFi network or password changes üòÖ. That is why I made extra effort to set up automatic WiFi provisioning. </p><p id="1af77955-515e-802e-9fc8-f43c5144dabb" class="">The way it works is that the ESP32 first creates a Bluetooth connection with the iOS <a href="https://apps.apple.com/us/app/esp-ble-provisioning/id1473590141">Provisioning app</a>. Then, you scan the WiFi QR code displayed on the screen that contains the connection details. Next, the app will connect to the device and configure WiFi credentials that are then stored in the device flash memory.</p><p id="1b077955-515e-803d-b5fe-f477e127679b" class="">Now, whenever the configured WiFi network is not available or the thermostat just can‚Äôt establish a connection for any reason, it will show the setup screen so you can restart the provisioning process and configure a new WiFi network.</p><figure id="1af77955-515e-803d-8cb1-f899ade90bbc" class="image"><a href="https://assets.jozefcipa.com/blog/12677955515e8037be53e7832bb10412/wifi_setup_screen.png"><img src="https://assets.jozefcipa.com/blog/12677955515e8037be53e7832bb10412/wifi_setup_screen.png"></a></figure><h2 id="1a777955-515e-809f-aa4c-c7660c16d157" class=""><strong>Electrical circuit</strong></h2><p id="1af77955-515e-80d4-acfa-ff0bbf98880b" class="">The electronic is pretty straightforward, and you can find the circuit below. The LCD, the temperature sensor, and the relay are all connected directly to the ESP32 board and that‚Äôs pretty much it üòÄ. </p><p id="1af77955-515e-80a7-8f74-ed9ddb264720" class="">
</p><figure id="1af77955-515e-803b-a39b-f28befa2c563" class="image"><a href="https://assets.jozefcipa.com/blog/12677955515e8037be53e7832bb10412/diagram.png"><img style="width:384px" src="https://assets.jozefcipa.com/blog/12677955515e8037be53e7832bb10412/diagram.png"></a></figure><figure id="1af77955-515e-80e2-97a0-d38b9877770b" class="image"><a href="https://assets.jozefcipa.com/blog/12677955515e8037be53e7832bb10412/enclosure.jpg"><img src="https://assets.jozefcipa.com/blog/12677955515e8037be53e7832bb10412/enclosure.jpg"></a></figure><h2 id="1b177955-515e-80fb-8ff6-e541a9d29567" class="">Conclusion</h2><p id="1af77955-515e-801c-86ed-ff681b956b02" class="">In total, the whole project cost less than 20‚Ç¨ (<em>ESP32 is usually extra 20‚Ç¨, but I got mine for free from the workshop</em>) and many mental breakdowns while trying to make things work :).</p><p id="1af77955-515e-808f-bd74-d250e4c1598d" class="">But, I learned <strong>a lot </strong>of new cool stuff. In fact, almost the entire project was something completely new to me. I learned more about ESP32 and ESP-IDF, how WiFi provisioning works, how to connect an LCD and make the touch screen work, what is a LVGL library and how to build UI interfaces in embedded systems.</p><p id="1af77955-515e-806c-bc2d-dc0ea88f46cc" class="">On top of that, I learned a lot of things about programming in C, how horrible and cool it is at the same time. And that all those memory crashes are a pain in the ass to debug. But it truly forces you to really understand what‚Äôs going on in the program.</p><p id="1b177955-515e-8082-a3f1-f94b04aee8d4" class="">So it was definitely a fun project to work on. If you are interested in the code, you can find everything on <a href="https://github.com/jozefcipa/homekit-thermostat">Github</a>.</p><p id="1b177955-515e-80d1-af6e-d469b53f1059" class="">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span>