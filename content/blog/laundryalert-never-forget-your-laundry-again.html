---
title: LaundryAlert - never forget your laundry again
tags:
  - iot
  - nodejs
  - api
  - frontend
  - databases
  - devops
date: '2024-02-01T10:20:07.498Z'
slug: laundryalert-never-forget-your-laundry-again
draft: false
---

<article id="1818227b-eb67-46a3-b709-2c63848c59b9" class="page sans"><div class="page-body"><p id="1a6b4a95-4409-415a-a620-9f2b62c7adc7" class="">
</p><figure id="1c844e02-093c-4e1c-8082-e2244128da9b" class="image"><a href="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/laundry-alert.jpeg"><img style="width:5712px" src="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/laundry-alert.jpeg"></a></figure><p id="5c5b7b9e-a22b-47e9-ab72-99ddbd311765" class="">
</p><p id="61f8b877-0cff-400d-8404-dfec7cea6234" class="">A few months ago I was hanging my laundry after it stayed in the washing machine for half a day before I remembered I had forgotten to take it out. And this didn‚Äôt happen for the first time. Maybe it happened to you too. I got fed up and that‚Äôs when I got an idea.</p><p id="96f5c2c0-14ad-49a4-9642-6803cafd7d04" class="">What if there was a way to notify me whenever the washing cycle ends? How could I make sure I don‚Äôt forget to take out the laundry anymore? Maybe I could build a small device that would be watching the washing machine and send me a push notification on my phone when the cycle completes (there is a sign that lights up). The fact that I had an old unused <a href="http://www.orangepi.org/">OrangePi</a> lying in my drawer for a couple of years motivated me even more to take on this project.</p><h2 id="ca87103c-be58-433e-8c64-bf09741e78ef" class="">How will it work?</h2><p id="a101b26e-e6df-46b9-938e-db20ed482b6c" class="">First of all, before even starting to work on my new side project, I had to verify whether it was even possible to send push notifications to my iPhone without building a regular iOS app. That would be too much work and I know nothing about iOS development.</p><p id="4b2aefcc-2093-46fb-9146-d3704e74cd94" class="">Luckily, I knew about this concept called <a href="https://developer.mozilla.org/en-US/docs/Web/Progressive_web_apps">progressive web app</a> (PWA), which allows you to create a website that can act as a native mobile app (to some extent). There are some limitations when it comes to the features that are supported, so I had to check if push notifications were working. I quickly drafted a very simple demo app and learned that it was possible. Game on! </p><p id="12917d10-6421-4193-9720-a17ca80d11db" class="">The next step was to come up with the design of the whole project, and figure out how would it all work together, from reading the sign on the washing machine and processing it, to sending a notification to my phone. </p><p id="a5241b75-e322-4837-8675-292328296daa" class="">After some thinking, this is what I came up with:</p><p id="ee1513f8-c4e8-4ec7-8d74-cb35dec2b573" class="">
</p><figure id="f40004e0-a5e2-4e77-bfc6-58360a5eda38" class="image"><a href="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/diagram.png"><img style="width:4488px" src="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/diagram.png"></a></figure><p id="b3a52975-6e35-4dca-bc57-12bd142bacbf" class="">
</p><p id="759a5d70-4150-40ef-8e2c-c3a8030fa5bc" class="">The whole project will consist of several independent parts that will communicate with each other.</p><p id="0b1272c4-aac1-492a-8876-f0a1193023cb" class="">First, we will have to create a simple website that will be then turned into a PWA and installed on the phone, this will be the user interface where users can see the actual state of the washing cycle and also register for the push notifications.</p><p id="6a798dfc-1540-4e3f-8a88-8b1d27ac62b6" class="">Then, we also need to add some electronics to read the light value from the washing machine. For this, we will use Arduino and a photoresistor.</p><p id="de829664-1748-486e-b735-1dcceddcc573" class="">Last but not least, a Node.js API, that will run on the mentioned OrangePi board and will take care of processing signals from Arduino and sending push notifications to the user‚Äôs device.</p><h2 id="4d01961a-65a3-42bd-9502-59495fc24e9c" class="">User interface (web client)</h2><p id="af6b717e-8659-440d-8702-9d07149b7d3e" class="">The website is quite simple, in fact, it only uses good old Javascript with no fancy libraries. The purpose of the app is just to provide a simple way for users to register their devices to receive push notifications.</p><p id="1e896e6f-000a-49f5-ace0-5c01c69d4ed9" class="">It is deployed on the internet (<a href="https://laundry.iot.jozefcipa.com/">laundry.iot.jozefcipa.com</a>) so whenever we open the app on the phone, it loads and shows some screen. Once the website is loaded, a request is sent to <code>192.168.0.100</code> which is the address of our OrangePi where our API is running. If the URL is not available, then the user is probably not on a local network and an error message will appear. Otherwise, the app shows a button for subscribing to notifications.</p><p id="8fe12b98-63c1-47b0-aa55-9c8210dd985d" class="">But before opening the app on the phone, we have to first install it as a web app. This can be done by opening the website in Safari and tapping on <em>Share</em> ‚Üí <em>Add to Home Screen</em>.</p><p id="90fd2943-3516-40d6-9f5e-ba77ae13117b" class="">
</p><div id="0883078d-23e8-4fe2-9e33-4545fd614962" class="column-list"><div id="dd42fcff-ce62-43ae-be05-042686ee1ab2" style="width:50%" class="column"><figure id="49a6c8cf-c302-4d0f-8c3c-604607bffd14" class="image"><a href="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/app-error.png"><img style="width:1170px" src="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/app-error.png"></a></figure></div><div id="f8add4ce-4424-4d39-ad5a-1d98f78b708a" style="width:50%" class="column"><figure id="7c6998b9-e0a5-486e-a9ff-904eaaec4da2" class="image"><a href="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/app-washing.png"><img style="width:1170px" src="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/app-washing.png"></a></figure></div></div><p id="84b0bd56-0a88-45a6-bac5-abd14b3fc00c" class="">
</p><h2 id="edf218ae-1a6d-4ffa-aa1a-df952b8b8d83" class="">Watching the washing machine (Arduino)</h2><p id="67891ffa-e7f0-4e1b-8570-a262d37fd140" class="">Another important part of the whole project is the actual sensor that will monitor light changes on the washing machine dashboard. For that, we use a photoresistor that is taped to the light signaling the end of the washing cycle.</p><p id="f62e51c4-9c08-442c-af50-f210f8b8fd97" class="">The value from the photoresistor is then read by the smallest and cheapest Arduino-compatible chip I could find - <a href="https://wiki.seeedstudio.com/Seeeduino-XIAO/">Seeduino XIAO</a>. As you can see in the picture below, it is very compact. The code is very simple, it constantly checks the value from the photoresistor and based on the specified threshold returns either a 1 or a 0 on one of the output pins. This pin is then read by OrangePi for further processing.</p><p id="adedf3cb-451d-46d4-a8e1-61163c07fd2f" class="">You might ask if this intermediate chip is really necessary and why can‚Äôt we connect the photoresistor directly to the OrangePi board. Well, I tried that of course, but the problem with OrangePi <a href="https://projects.raspberrypi.org/en/projects/physical-computing/1">GPIO</a> pins is that they are digital, meaning they can only work with 0/1 values, so this wasn‚Äôt functioning well with the intensity of the washing machine light.</p><p id="c2f7f140-9ce6-4c42-8923-4e1f2c1b2019" class="">After that, I decided to buy an A/D converter chip (MCP3002) that converts analog values read from the photoresistor to digital values used by OrangePi. This solution, however, was a bit more complicated than I anticipated and I wasn‚Äôt able to make it work. </p><p id="ebdee6f4-4a7e-47b8-a12c-6e40056ece34" class="">Since I‚Äôm really bad with electronics, I decided to go with maybe an overkill solution but the one I was certain would work - using an Arduino chip that I can easily program and tell it exactly what I want it to do. I am a programmer after all ü§∑‚Äç‚ôÇÔ∏è.</p><p id="f0d675f2-5385-409e-ae80-90861304f536" class="">
</p><figure id="8b9499f2-7b67-40d9-9a53-d1564feed1a9" class="image"><a href="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/seeduino.jpeg"><img style="width:4032px" src="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/seeduino.jpeg"></a></figure><h2 id="dd35d241-0135-41cd-88ac-e4eda1c17901" class="">Sending notifications (Node.js API)</h2><p id="93febc7f-2138-4839-a1ff-4b9329154e4f" class="">The API is the control center of the whole application. It registers user notification tokens, periodically evaluates data from the sensor, and sends notifications to the users.</p><p id="73b068fb-bbfd-403b-9044-c4288a77eede" class="">As it‚Äôs an API, I decided to use Express for the routing. It exposes two endpoints</p><ul id="e2089977-99e5-4436-a2c1-e25f7b39cab8" class="bulleted-list"><li style="list-style-type:disc"><code>GET /</code> - Returns application status and uptime</li></ul><ul id="9165d060-07a4-48b5-8ac8-1ab6cc9f92f0" class="bulleted-list"><li style="list-style-type:disc"><code>POST /notifications/subscribe</code> - Registers user‚Äôs notification token</li></ul><p id="295207f8-47c3-4c60-8319-e9bf26d43270" class="">The notification tokens are then stored in a SQLite database.</p><p id="41a67aee-0e12-46f9-816e-2f5e6559ac57" class="">Notifications are sent using the <a href="https://www.npmjs.com/package/web-push">web-push</a> npm package that uses Web Push Protocol for sending push notifications to browsers.</p><p id="f3e99f3b-3c30-4628-8643-7d6759cd8fbf" class="">Last but not least, the API has the concept of intervals - it‚Äôs a plain <code>setInterval</code> function being called periodically and performing some stuff. In our application, we use two of these</p><ul id="1b13e5aa-2e54-44c2-8734-960190d7aacb" class="bulleted-list"><li style="list-style-type:disc">LED interval - every 2 seconds, it blinks the LED through the GPIO conveying that the application is working</li></ul><ul id="c65f2e47-3322-44ab-a615-23756dec5edd" class="bulleted-list"><li style="list-style-type:disc">Photoresistor interval - every 5 seconds, it reads the GPIO pin to see what the value from Arduino (1/0) is, and based on that it then decides whether to send the push notifications or not.</li></ul><h2 id="0acea7cd-b87e-4e29-9062-4973cb620713" class="">Putting it all together (OrangePi)</h2><p id="2d565b3b-9da5-49a9-835e-5207b80c2eb1" class="">Now that we have the code ready, we can install everything on OrangePi.</p><p id="66c5eb45-a1d6-4eab-9e41-25cd0c7eb16e" class="">The first thing to do is to format the SD card and install Linux on it. After that, I installed Node.js, <a href="https://pm2.keymetrics.io/">pm2</a> process manager, Nginx, and the GPIO <a href="https://github.com/orangepi-xunlong/wiringOP">library</a>. As we want to be able to connect to the board remotely, I configured the static IP address and disabled the DHCP client.</p><p id="ce04c30c-e618-4340-8e5a-52d728a2b564" class="">The next important step was to configure GPIO pins. GPIO (General-Purpose Input Output) is a set of digital pins on an electronic circuit board that allows connecting other peripherals and is controllable by software. This gives us great power as we can write high-level code and communicate with custom electronic devices easily. We need two of these pins, one for the signaling LED (output) that will be blinking once the API starts and another one for reading the photoresistor data from Arduino (input).</p><p id="076a2e78-7a8d-433b-95a8-9c4a18ef1a58" class="">As web apps on iPhones only allow HTTPS connections, I had to implement SSL certificates for the API. Since the API is running locally (and not on the internet) I couldn‚Äôt use any public free certificate authority, such as Let‚Äôs Encrypt but instead had to generate self-signed certificates. For that, I used an amazing tool called <a href="https://github.com/FiloSottile/mkcert">mkcert</a>. However, as we generate custom certificates, these are naturally not recognized by browsers and they will complain and show the warning that the connection is not private.</p><p id="11f511bb-31ef-4b43-9d31-4f8880e34e13" class="">Therefore, I had to first figure out how to register a custom certificate authority, so my self-signed certificates would be accepted in the browser. Luckily, <code>mkcert</code> does that automatically for us on computers, but for my iPhone, I had to <a href="https://jozefcipa.com/blog/self-signed-ssl-certificates-on-ios/">configure it manually</a>.</p><p id="da4a5a4e-176d-4704-8fa6-096e7eda6584" class="">Once I had all of that sorted out, I copied the application code and ran <code>pm2</code> to start the API automatically after booting and configured Nginx as a proxy server.</p><p id="42a4e16a-63af-44cd-82a0-ec6ae8a250a8" class="">The last step was to put everything into a nice case. It was a bit of a struggle to fit everything inside but I think the result is awesome.</p><p id="26f09433-0198-45bd-ab00-bc4a410f8d55" class="">
</p><figure id="753d59f7-29c4-4222-bd16-c8e3c069438c" class="image"><a href="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/in-progres.jpeg"><img style="width:4032px" src="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/in-progres.jpeg"></a></figure><p id="04b9b503-9caf-48b2-b4e7-ec3150a2c6cc" class="">
</p><figure id="261c4c57-842e-4b77-86f9-8f513fe5f29c" class="image"><a href="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/case.jpeg"><img style="width:4032px" src="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/case.jpeg"></a></figure><p id="dc2a6ba5-12de-4528-b46f-c460d5d09337" class="">
</p><figure id="e91cf357-bb1c-4483-bab7-a52da85abf5b" class="image"><a href="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/debugging.jpeg"><img style="width:4032px" src="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/debugging.jpeg"></a></figure><p id="18be82b4-ac63-4180-b925-62bea3e8b678" class="">
</p><figure id="6e137c82-ddef-43ec-bdfe-a3a3211bbd87" class="image"><a href="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/app-notification.png"><img style="width:288px" src="https://assets.jozefcipa.com/blog/1818227beb6746a3b7092c63848c59b9/app-notification.png"></a></figure><p id="a9fd7107-985b-4ce8-b09f-11f04924d2c0" class="">
</p><h2 id="7f62ffdd-a1e3-4e81-9f7e-cdbc85d35b79" class="">Concluding thoughts</h2><p id="94004f08-639e-43ca-88fc-3fb54fe3d694" class="">After I completed all the parts it was time to verify if it was working. Even though it seemed to be a pretty simple project in the beginning, I faced many challenges along the way where things didn‚Äôt go as planned. I could keep telling you about situations like non-working WiFi on the board when I had to eventually use the Ethernet port or the CPU overheating, so I had to add a fan just to find out that now the AC adapter was not powerful enough, or static IP address acting up, soldering struggles, my failed attempts to make the A/D chip work and so many more‚Ä¶ </p><p id="3f8cc35c-9229-4dfb-b908-a75c50ea9bf1" class="">But after all these long nights spent debugging and trying out to make things work it was so rewarding to eventually see that one push notification appearing on my phone when the washing ended.</p><p id="74561eee-4bbb-4d81-8d4d-d37340270106" class="">Especially, as my bread and butter is sitting in front of the computer all day long, it was nice building something tangible. </p><p id="5878b77f-1f64-42ce-938d-42ff68d46cbe" class="">I had a lot of fun building this project and if you enjoyed reading the article, feel free to add comments. If you‚Äôre interested in the code and all the details, you can find the complete project documented on <a href="https://github.com/jozefcipa/laundry-alert">GitHub</a>.</p><p id="9114604c-34eb-4cf0-8668-29aa6c9b91c6" class="">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span>